/* HEPL RIA 2013 - Test One
 *
 * JS Document - /js/main.js
 *
 * coded by [Julien Roland]
 * started at 28/10/13
 *//* jshint boss: true, curly: true, eqeqeq: true, eqnull: true, immed: true, latedef: true, newcap: true, noarg: true, browser: true, jquery: true, noempty: true, sub: true, undef: true, unused: true, white: false */(function(e){"use strict";var t,n=new google.maps.LatLng(50.833,4.333),r,i=new google.maps.Marker,s="./img/framework/icon/markerBank.png",o="./img/framework/icon/markerMy.png",u,a,f,l=e(".listing"),c=e("#agence"),h=e(".listGlobal .dimension"),p=e(".showMap"),d=e(".app"),v=e(".appDistrib"),m=e(".appOne"),g=10,y=10,b=60,w=50,E=5,S=1,x=1,T=[],N,C="/cashcash/";e(function(){c.on("change",Y);l.on("click",".more a",G);h.on("click","a",V);e(".mapInteraction").on("click","a",X);e(".reload").on("click","a",P);p.on("click","a",B);v.on("click","a",j);e(".time").on("click","a",U);l.on("click",".bank a",F);e(".back").on("click","a",A);console.log(location.pathname.replace(C,"").replace(".html",""));location.pathname!==C&&location.pathname!==C+"index.html"&&_(location.pathname.replace(C,"").replace(".html",""));window.addEventListener("popstate",O)});var k=function(){e(".loading").delay(500).fadeOut("slow");L();history.pushState({selector:".app"},"index","index.html");H()},L=function(){t=new google.maps.Map(document.getElementById("gmap"),{center:n,zoom:14,disableDefaultUI:!0,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP})},A=function(){history.back()},O=function(e){D(e.state?e.state:"index.html")},M=function(){f=a[this.id];q(f,this.id)},_=function(e){if(e==="index"){v.fadeOut("fast");m.fadeOut("fast");d.fadeIn("fast")}else if(e==="carte"){d.fadeOut("fast");m.fadeOut("fast");v.fadeIn("fast")}},D=function(n){if(n){var i=e(n.selector);if(i.selector===d.selector){v.fadeOut("fast");m.fadeOut("fast");d.fadeIn("fast");for(var s=0;s<=g-1;s++)r[s].setMap(t);Z()}else if(i.selector===v.selector){d.fadeOut("fast");m.fadeOut("fast");v.fadeIn("fast");for(var s=0;s<=g-1;s++)r[s].setMap(t);Z()}else if(i.selector===m.selector){d.fadeOut("fast");v.fadeOut("fast");m.fadeIn("fast")}}},P=function(){location.reload()},H=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(et,nt):alert("Impossible de vous localiser !")},B=function(e){e.preventDefault();history.pushState({selector:".appDistrib"},e.target.rel,e.target.rel+".html");d.fadeOut("fast");v.fadeIn()},j=function(e){e.preventDefault();history.pushState({selector:".app"},e.target.rel,e.target.rel+".html");v.fadeOut("fast");d.fadeIn()},F=function(t){t.preventDefault();history.pushState({selector:".appOne"},e(this).attr("rel"),e(this).attr("rel").toLowerCase().split(" ").join("-")+".html");v.fadeOut("fast");d.fadeOut("fast");m.fadeIn();var n=parseFloat(e(this).attr("data-id"));console.log(r);f=a[n];I(n);m.find(".details").css("background-color","#"+f.bank.color);m.find("img").attr("src",f.bank.icon);m.find("h2").html(f.bank.name);m.find("h2>a").attr("href",f.bank.url);m.find("address").html(f.address);m.find(".nb").html(W(f.distance)+"'");m.find(".nb").attr("data-distance",f.distance);m.find(".distance>span").html(f.distance+"m")},I=function(e){for(var n=0;n<=g-1;n++)n!==e&&r[n].setMap(null);var i=new google.maps.LatLng(a[e].latitude,a[e].longitude);t.panTo(i)},q=function(e,t){history.pushState({selector:".appOne"},e.bank.name,"bank-"+e.bank.name.toLowerCase().split(" ").join("-")+".html");v.fadeOut("fast");d.fadeOut("fast");m.fadeIn();I(t);m.find(".details").css("background-color","#"+e.bank.color);m.find("img").attr("src",e.bank.icon);m.find("h2").html(e.bank.name);m.find("h2>a").attr("href",e.bank.url);m.find("address").html(e.address);m.find(".nb").html(W(e.distance)+"'");m.find(".nb").attr("data-distance",e.distance);m.find(".distance>span").html(e.distance+"m")},R=function(){var e=c.find("option"),t;if(e.size()>1){e.remove();for(t=0;t<=T.length-1;t++)c.append('<option value="'+T[t][0]+'">'+T[t][1]+"</option>");c.find("option:first-child").before('<option value="0">Toutes</option>')}else{for(t=0;t<=T.length-1;t++)c.append('<option value="'+T[t][0]+'">'+T[t][1]+"</option>");l.append('<li class="more"><a href="" title="Voir plus de banques"><span class="icon icon-plus-grey"></span><span>Voir plus de distributeurs</span></a></li>')}},U=function(t){t.preventDefault();var n;if(x===1){n=parseFloat(e(this).find(".nb").attr("data-distance"));m.find(".nb").html(z(n)+'"');m.find(".icon").removeClass("icon-foot");m.find(".icon").addClass("icon-car");x=2}else if(x===2){n=parseFloat(e(this).find(".nb").attr("data-distance"));m.find(".nb").html(W(n)+"'");m.find(".icon").removeClass("icon-car");m.find(".icon").addClass("icon-foot");x=1}},z=function(e){return Math.round(b*60/(w*1e3)*e)},W=function(e){return Math.round(b/E*parseFloat(e)/1e3)},X=function(e){e.preventDefault();H()},V=function(e){e.preventDefault();var t;t=l.find(".dimension");if(S===1){$(t);h.find("a").css({backgroundImage:"url(./img/framework/icon/walk.png)"})}else if(S===2){K(t);h.find("a").css({backgroundImage:"url(./img/framework/icon/bird.png)"})}else if(S===3){J(t);h.find("a").css({backgroundImage:"url(./img/framework/icon/car.png)"})}},$=function(t){t.each(function(){var t=Math.round(b*60/(w*1e3)*parseFloat(e(this).attr("data-dimension")));e(this).html(t+'"')});S=2},J=function(t){t.each(function(){var t=e(this).attr("data-dimension");e(this).html(t+"m")});S=1},K=function(t){t.each(function(){var t=Math.round(b/E*parseFloat(e(this).attr("data-dimension"))/1e3);e(this).html(t+"'")});S=3},Q=function(t,n){for(var r=0;r<=g;r++)if(e.inArray(t,n[r])>=0)return!0},G=function(t){t.preventDefault();var n=e(".more");if(g+y<=a.length){for(var r=g;r<=g+y-1;r++)if(a[r].bank){n.before('<li class="bank" data-idBank="'+a[r].bank.id+'"><a data-id="'+r+'" href="javascript:void()" rel="'+a[r].bank.name+'" title="Voir la fiche de la'+a[r].bank.name+'"><span class="overBank" style="color:white;background-color:#'+a[r].bank.color+'">Voir cette bank ('+a[r].bank.name+')</span><div class="infosBank" data-type="'+a[r].bank.color+'"><div class="logoBank"><img src="'+a[r].bank.icon+'" alt="Logo de la bank '+a[r].bank.name+'"></div><span style="color:#'+a[r].bank.color+'" class="titleBank">'+a[r].bank.name+'</span></div><div class="dimension" data-dimension="'+a[r].distance+'" style="background-color:#'+a[r].bank.color+'"><span>'+a[r].distance+"</span></div></a></li>");Q(a[r].bank.id,T)||T.push([a[r].bank.id,a[r].bank.name])}R();it();g+=y}else{n.remove();alert("Il n' a pas d'autre distributeur dans la r√©gion !")}},Y=function(){var t=parseFloat(e(this).find("option:selected").val()),n=e(".listing li");if(t===0)n.slideDown();else{n.not("[data-idBank='"+t+"']").slideUp();e('.listing li[data-idBank="'+t+'"]').slideDown()}},Z=function(){var e=new google.maps.LatLng(u.latitude,u.longitude);t.panTo(e)},et=function(e){u=e.coords;i.setMap(t);i.setPosition(new google.maps.LatLng(u.latitude,u.longitude));i.setIcon(o);Z();rt()},tt=function(e,t){var n=10;return"http://ccapi.superacid.be/terminals?latitude="+e+"&longitude="+t+"&radius="+n},nt=function(e){console.log(e)},rt=function(){N=tt(u.latitude,u.longitude);e.ajax({url:N,dataType:"json",type:"GET",cache:"true",success:function(e){if(e.error===!1){a=e.data;st(g);R();it()}}})},it=function(){var e;if(!r){r=[];for(var n=0;n<=g-1;n++){e=new google.maps.Marker({position:new google.maps.LatLng(a[n].latitude,a[n].longitude),map:t,icon:s,id:n,title:"Voir le detail de la banque"});r.push(e);google.maps.event.addListener(e,"click",M)}}else for(var n=g;n<=g+y-1;n++){e=new google.maps.Marker({position:new google.maps.LatLng(a[n].latitude,a[n].longitude),map:t,icon:s,id:n,title:"Voir le detail de la banque"});r.push(e);google.maps.event.addListener(e,"click",M)}},st=function(e){if(e+y<=a.length)for(var t=0;t<=e-1;t++)if(a[t].bank){l.append('<li class="bank" data-idBank="'+a[t].bank.id+'"><a data-id="'+t+'" rel="'+a[t].bank.name+'" href="javascript:void()" title="Voir la fiche de la'+a[t].bank.name+'"><span class="overBank" style="color:white;background-color:#'+a[t].bank.color+'">Voir cette bank ('+a[t].bank.name+')</span><div class="infosBank" data-type="'+a[t].bank.color+'"><div class="logoBank"><img src="'+a[t].bank.icon+'" alt="Logo de la bank '+a[t].bank.name+'"></div><span style="color:#'+a[t].bank.color+'" class="titleBank">'+a[t].bank.name+'</span></div><div class="dimension" data-dimension="'+a[t].distance+'" style="background-color:#'+a[t].bank.color+'"><span>'+a[t].distance+"</span></div></a></li>");Q(a[t].bank.id,T)||T.push([a[t].bank.id,a[t].bank.name])}};e(window).ready(k)}).call(this,jQuery);