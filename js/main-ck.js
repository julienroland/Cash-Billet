/* HEPL RIA 2013 - Test One
 *
 * JS Document - /js/main.js
 *
 * coded by [Julien Roland]
 * started at 28/10/13
 *//* jshint boss: true, curly: true, eqeqeq: true, eqnull: true, immed: true, latedef: true, newcap: true, noarg: true, browser: true, jquery: true, noempty: true, sub: true, undef: true, unused: true, white: false */(function(e){"use strict";var t,n=new google.maps.LatLng(50.833,4.333),r,i=new google.maps.Marker,s="./img/framework/icon/markerBank.png",o="./img/framework/icon/markerMy.png",u,a,f,l=e(".listing"),c=e("#agence"),h=e(".listGlobal .dimension"),p=e(".showMap"),d=e(".app"),v=e(".appDistrib"),m=e(".appOne"),g=10,y=10,b=60,w=50,E=5,S=1,x=1,T=[],N,C="/cashcash/";e(function(){c.on("change",Z);l.on("click",".more a",Y);h.on("click","a",$);e(".mapInteraction").on("click","a",V);e(".reload").on("click","a",H);p.on("click","a",j);v.on("click","a",F);e(".time").on("click","a",z);l.on("click",".bank a",I);e(".back").on("click","a",O);console.log(location.pathname.replace(C,"").replace(".html",""));location.pathname!==C&&location.pathname!==C+"index.html"&&D(location.pathname.replace(C,"").replace(".html",""));window.addEventListener("popstate",M)});var k=function(){A();history.pushState({selector:".app"},"index","index.html");B()},L=function(){e(".overlay").fadeOut("slow")},A=function(){t=new google.maps.Map(document.getElementById("gmap"),{center:n,zoom:14,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP})},O=function(){history.back()},M=function(e){P(e.state?e.state:"index.html")},_=function(){f=a[this.id];R(f,this.id)},D=function(e){if(e=="index"){v.fadeOut("fast");m.fadeOut("fast");d.fadeIn("fast")}else if(e=="carte"){d.fadeOut("fast");m.fadeOut("fast");v.fadeIn("fast")}},P=function(n){if(n){var i=e(n.selector);if(i.selector===d.selector){v.fadeOut("fast");m.fadeOut("fast");d.fadeIn("fast");for(var s=0;s<=g-1;s++)r[s].setMap(t);et()}else if(i.selector===v.selector){d.fadeOut("fast");m.fadeOut("fast");v.fadeIn("fast");for(var s=0;s<=g-1;s++)r[s].setMap(t);et()}else if(i.selector===m.selector){d.fadeOut("fast");v.fadeOut("fast");m.fadeIn("fast")}}},H=function(){location.reload()},B=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){tt(e);L()},function(){rt()}):alert("Impossible de vous localiser !")},j=function(e){e.preventDefault();history.pushState({selector:".appDistrib"},e.target.rel,e.target.rel+".html");d.fadeOut("fast");v.fadeIn()},F=function(e){e.preventDefault();history.pushState({selector:".app"},e.target.rel,e.target.rel+".html");v.fadeOut("fast");d.fadeIn()},I=function(t){t.preventDefault();history.pushState({selector:".appOne"},e(this).attr("rel"),e(this).attr("rel").toLowerCase().split(" ").join("-")+".html");v.fadeOut("fast");d.fadeOut("fast");m.fadeIn();var n=parseFloat(e(this).attr("data-id"));f=a[n];q(n);m.find(".details").css("background-color","#"+f.bank.color);m.find("img").attr("src",f.bank.icon);m.find("h2").html(f.bank.name);m.find("h2>a").attr("href",f.bank.url);f.address!==""?m.find("address").html(f.address):m.find(".address").hide();m.find(".nb").html(X(f.distance));m.find(".nb").attr("data-distance",f.distance);m.find(".distance>span").html(f.distance+"m")},q=function(e){for(var n=0;n<=g-1;n++)n!==e&&r[n].setMap(null);var i=new google.maps.LatLng(a[e].latitude+.008,a[e].longitude);t.panTo(i)},R=function(e,t){history.pushState({selector:".appOne"},e.bank.name,"bank-"+e.bank.name.toLowerCase().split(" ").join("-")+".html");v.fadeOut("fast");d.fadeOut("fast");m.fadeIn();q(t);m.find(".details").css("background-color","#"+e.bank.color);m.find("img").attr("src",e.bank.icon);m.find("h2").html(e.bank.name);m.find("h2>a").attr("href",e.bank.url);e.address!==null?m.find("address").html(e.address):m.find(".address").hide();m.find(".nb").html(X(e.distance)+"min");m.find(".nb").attr("data-distance",e.distance);m.find(".distance>span").html(e.distance+"m")},U=function(){var e=c.find("option"),t;if(e.size()>1){e.remove();for(t=0;t<=T.length-1;t++)c.append('<option value="'+T[t][0]+'">'+T[t][1]+"</option>");c.find("option:first-child").before('<option value="0">Toutes</option>')}else{for(t=0;t<=T.length-1;t++)c.append('<option value="'+T[t][0]+'">'+T[t][1]+"</option>");l.append('<li class="more"><a href="" title="Voir plus de banques"><span class="icon icon-plus-grey"></span><span>Voir plus de distributeurs</span></a></li>')}},z=function(t){t.preventDefault();var n;if(x===1){n=parseFloat(e(this).find(".nb").attr("data-distance"));m.find(".nb").html(W(n));m.find(".icon").removeClass("icon-foot");m.find(".icon").addClass("icon-car");x=2}else if(x===2){n=parseFloat(e(this).find(".nb").attr("data-distance"));m.find(".nb").html(X(n));m.find(".icon").removeClass("icon-car");m.find(".icon").addClass("icon-foot");x=1}},W=function(e){var t=b*b/(w*1e3)*e;if(t>=b){var n=Math.floor(t/b)+"min",r=Math.round(t%b)+"s";return n+r}return Math.round(t)+"s"},X=function(e){var t=b/E*parseFloat(e)/1e3;if(t<1)return Math.round(t/1*b)+"s";var n=t*b,r=Math.floor(n/b)+"min",i=Math.round(n%b)+"s";return r+i},V=function(e){e.preventDefault();B()},$=function(e){e.preventDefault();var t;t=l.find(".dimension");if(S===1){J(t);h.find("a").css({backgroundImage:"url(./img/framework/icon/walk.png)"})}else if(S===2){Q(t);h.find("a").css({backgroundImage:"url(./img/framework/icon/bird.png)"})}else if(S===3){K(t);h.find("a").css({backgroundImage:"url(./img/framework/icon/car.png)"})}},J=function(t){t.each(function(){var t=b*b/(w*1e3)*parseFloat(e(this).attr("data-dimension"));if(t>=b){var n=Math.floor(t/b)+"min",r=Math.round(t%b)+"s";e(this).html(n+r)}else e(this).html(Math.round(t)+"s")});S=2},K=function(t){t.each(function(){var t=e(this).attr("data-dimension");e(this).html(t+"m")});S=1},Q=function(t){t.each(function(){var t=b/E*parseFloat(e(this).attr("data-dimension"))/1e3;if(t<1){t=Math.round(t/1*b);e(this).html(t+"")}else{var n=t*b,r=Math.floor(n/b)+"min",i=Math.round(n%b)+"s";e(this).html(r+i)}});S=3},G=function(t,n){for(var r=0;r<=g;r++)if(e.inArray(t,n[r])>=0)return!0},Y=function(t){t.preventDefault();var n=e(".more"),r;if(g+y<=a.length){for(var i=g;i<=g+y-1;i++)if(a[i].bank){S===1?r=a[i].distance+"m":S===2?r=W(a[i].distance):S===3&&(r=X(a[i].distance));n.before('<li class="bank" data-idBank="'+a[i].bank.id+'"><a data-id="'+i+'" href="javascript:void()" rel="'+a[i].bank.name+'" title="Voir la fiche de la'+a[i].bank.name+'"><span class="overBank" style="color:white;background-color:#'+a[i].bank.color+'">Voir cette banque ('+a[i].bank.name+')</span><div class="infosBank" data-type="'+a[i].bank.color+'"><div class="logoBank"><img src="'+a[i].bank.icon+'" alt="Logo de la bank '+a[i].bank.name+'"></div><span style="color:#'+a[i].bank.color+'" class="titleBank">'+a[i].bank.name+'</span></div><div class="dimension" data-dimension="'+a[i].distance+'" style="background-color:#'+a[i].bank.color+'"><span>'+r+"</span></div></a></li>");G(a[i].bank.id,T)||T.push([a[i].bank.id,a[i].bank.name])}U();st();g+=y}else{n.remove();alert("Il n' a pas d'autre distributeur dans la région !")}},Z=function(){var t=parseFloat(e(this).find("option:selected").val()),n=e(".listing li");if(t===0)n.slideDown();else{n.not("[data-idBank='"+t+"']").slideUp();e('.listing li[data-idBank="'+t+'"]').slideDown()}},et=function(){var e=new google.maps.LatLng(u.latitude,u.longitude);t.panTo(e)},tt=function(e){u=e.coords;i.setMap(t);i.setPosition(new google.maps.LatLng(u.latitude,u.longitude));i.setIcon(o);et();it()},nt=function(e,t){var n=10;return"http://ccapi.superacid.be/terminals?latitude="+e+"&longitude="+t+"&radius="+n},rt=function(){alert("Erreur de localisation, veuillez rafraichir")},it=function(){N=nt(u.latitude,u.longitude);e.ajax({url:N,dataType:"json",type:"GET",cache:"true",success:function(e){if(e.error===!1){a=e.data;ot(g);U();st()}}})},st=function(){var e;if(!r){r=[];for(var n=0;n<=g-1;n++){e=new google.maps.Marker({position:new google.maps.LatLng(a[n].latitude,a[n].longitude),map:t,icon:s,id:n,title:"Voir le detail de la banque"});r.push(e);google.maps.event.addListener(e,"click",_)}}else for(var n=g;n<=g+y-1;n++){e=new google.maps.Marker({position:new google.maps.LatLng(a[n].latitude,a[n].longitude),map:t,icon:s,id:n,title:"Voir le detail de la banque"});r.push(e);google.maps.event.addListener(e,"click",_)}},ot=function(t){if(t+y<=a.length)for(var n=0;n<=t-1;n++)if(a[n].bank){e(".nbDistrib").html(a.length+" distributeurs à proximité");l.append('<li class="bank" data-idBank="'+a[n].bank.id+'"><a data-id="'+n+'" rel="'+a[n].bank.name+'" href="javascript:void()" title="Voir la fiche de la'+a[n].bank.name+'"><span class="overBank" style="color:white;background-color:#'+a[n].bank.color+'">Voir cette banque ('+a[n].bank.name+')</span><div class="infosBank" data-type="'+a[n].bank.color+'"><div class="logoBank"><img src="'+a[n].bank.icon+'" alt="Logo de la bank '+a[n].bank.name+'"></div><span style="color:#'+a[n].bank.color+'" class="titleBank">'+a[n].bank.name+'</span></div><div class="dimension" data-dimension="'+a[n].distance+'" style="background-color:#'+a[n].bank.color+'"><span>'+a[n].distance+"m</span></div></a></li>");G(a[n].bank.id,T)||T.push([a[n].bank.id,a[n].bank.name])}};e(window).ready(k)}).call(this,jQuery);